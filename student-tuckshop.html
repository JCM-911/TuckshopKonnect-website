<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Tuckshop - TuckshopKonnect</title>
    
    <!-- External CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <style>
        /* Same styles as before */
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar navbar-expand-lg">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-graduation-cap me-2"></i>TuckshopKonnect
                </a>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#"><i class="fas fa-store me-1"></i>Tuckshop</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showTransactionHistory()"><i class="fas fa-history me-1"></i>History</a>
                        </li>
                    </ul>
                    
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <div class="balance-display" id="balanceDisplay">
                                <i class="fas fa-wallet me-1"></i>Loading...
                            </div>
                        </li>
                        <li class="nav-item">
                            <button class="cart-btn" onclick="toggleCart()">
                                <i class="fas fa-shopping-cart me-1"></i>Cart
                                <span class="cart-count" id="cartCount">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link btn btn-link" onclick="confirmLogout()">
                                <i class="fas fa-sign-out-alt me-1"></i><span id="headerStudentName"></span> - Logout
                            </button>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="content-container">
        <div class="container">
            <!-- Welcome Section -->
            <div class="welcome-section fade-in">
                <h1 class="welcome-title">Welcome to the Tuckshop!</h1>
                <p id="studentName" style="color: rgba(255, 255, 255, 0.8); font-size: 1.2rem; margin-bottom: 0;">Loading...</p>
            </div>

            <!-- Search and Filter Bar -->
            <div class="filter-bar fade-in">
                <input type="text" id="searchInput" class="form-control" placeholder="Search for items...">
                <button class="btn btn-primary" onclick="applySearch()">Search</button>
            </div>

            <!-- Products Grid -->
            <div class="products-grid fade-in" id="productsGrid">
                <!-- Products will be populated here -->
            </div>

            <!-- Pagination Controls -->
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center" id="paginationControls">
                    <!-- Pagination will be populated here -->
                </ul>
            </nav>
        </div>
    </main>

    <!-- Cart Sidebar -->
    <div class="cart-overlay" id="cartOverlay" onclick="closeCart()"></div>
    <div class="cart-sidebar" id="cartSidebar">
        <!-- Cart structure remains the same -->
    </div>

    <!-- Receipt Modal -->
    <div class="modal fade" id="receiptModal" tabindex="-1">
        <!-- Modal structure remains the same -->
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentUser = null;
        let products = [];
        let cart = JSON.parse(sessionStorage.getItem('cart')) || [];
        let currentPage = 1;

        document.addEventListener('DOMContentLoaded', function() {
            const token = sessionStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'student-login.html';
                return;
            }

            currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            
            if (!currentUser) {
                logout();
                return;
            }
            
            setupUI();
            fetchProducts();
            updateCartUI();
        });

        function setupUI() {
            document.getElementById('headerStudentName').textContent = currentUser.name.split(' ')[0];
            document.getElementById('studentName').textContent = `Welcome, ${currentUser.name}`;
            updateBalance(currentUser.balance);
        }

        function updateBalance(balance) {
            currentUser.balance = balance;
            document.getElementById('balanceDisplay').innerHTML = `<i class="fas fa-wallet me-1"></i>₦${balance.toLocaleString()}`;
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
        }

        async function fetchProducts(page = 1, search = '') {
            const token = sessionStorage.getItem('authToken');
            currentPage = page;
            try {
                const response = await fetch(`/api/items?page=${page}&limit=10&search=${search}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch products');
                const data = await response.json();
                products = data.items;
                renderProducts();
                renderPagination(data.totalPages);
            } catch (error) {
                console.error('Error fetching products:', error);
                document.getElementById('productsGrid').innerHTML = '<p class="text-white">Could not load products. Please try again later.</p>';
            }
        }

        function applySearch() {
            const searchTerm = document.getElementById('searchInput').value;
            fetchProducts(1, searchTerm);
        }

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-image">
                        <img src="${product.imageUrl || 'https://via.placeholder.com/300'}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div class="product-info">
                        <h4 class="product-name">${product.name}</h4>
                        <p class="product-description">${product.description}</p>
                        <div class="product-price">₦${product.price.toLocaleString()}</div>
                        <button class="add-to-cart-btn" onclick="addToCart('${product._id}')">
                            Add to Cart
                        </button>
                    </div>
                `;
                grid.appendChild(productCard);
            });
        }

        function renderPagination(totalPages) {
            const paginationControls = document.getElementById('paginationControls');
            paginationControls.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="fetchProducts(${i})">${i}</a>`;
                paginationControls.appendChild(li);
            }
        }

        function addToCart(productId) {
            const product = products.find(p => p._id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item._id === productId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            updateCartUI();
        }

        function updateCartUI() {
            sessionStorage.setItem('cart', JSON.stringify(cart));
            const cartCount = document.getElementById('cartCount');
            const cartBody = document.getElementById('cartBody');
            const cartFooter = document.getElementById('cartFooter');
            const cartTotal = document.getElementById('cartTotal');

            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            cartCount.textContent = totalItems;
            
            if (cart.length === 0) {
                cartBody.innerHTML = '<div class="cart-empty"><i class="fas fa-shopping-cart"></i><h5>Your cart is empty</h5></div>';
                cartFooter.style.display = 'none';
            } else {
                cartBody.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <p>${item.name} (x${item.quantity})</p>
                        <p>₦${(item.price * item.quantity).toLocaleString()}</p>
                    </div>
                `).join('');
                cartTotal.textContent = `₦${totalPrice.toLocaleString()}`;
                cartFooter.style.display = 'block';

                const checkoutBtn = document.getElementById('checkoutBtn');
                if (totalPrice > currentUser.balance) {
                    checkoutBtn.disabled = true;
                    checkoutBtn.textContent = 'Insufficient Funds';
                } else {
                    checkoutBtn.disabled = false;
                    checkoutBtn.textContent = 'Purchase Items';
                }
            }
        }

        async function processCheckout() {
            const token = sessionStorage.getItem('authToken');
            const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const cartItems = cart.map(item => ({ item: item._id, quantity: item.quantity, price: item.price }));

            try {
                const response = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        amount: totalPrice,
                        type: 'purchase',
                        description: 'Tuckshop Purchase',
                        userId: currentUser._id,
                        items: cartItems
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Checkout failed');
                }

                await fetchAndUpdateBalance();
                alert('Purchase successful!');
                cart = [];
                updateCartUI();
                closeCart();
            } catch (error) {
                console.error('Checkout error:', error);
                alert(`Error: ${error.message}`);
            }
        }

        async function fetchAndUpdateBalance() {
            const token = sessionStorage.getItem('authToken');
            try {
                const response = await fetch('/api/users/profile', { // Assuming this endpoint exists
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) return;
                const updatedUser = await response.json();
                updateBalance(updatedUser.balance);
            } catch (error) {
                console.error('Error fetching updated balance:', error);
            }
        }
        
        async function showTransactionHistory() {
            const token = sessionStorage.getItem('authToken');
            try {
                const response = await fetch('/api/transactions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch history');
                const data = await response.json();
                const transactions = data.transactions;
                
                // For simplicity, using alert to show history. A modal is better.
                let history = 'Transaction History:\n\n';
                transactions.forEach(t => {
                    history += `Type: ${t.type}, Amount: ₦${t.amount}, Date: ${new Date(t.createdAt).toLocaleDateString()}\n`;
                });
                alert(history);

            } catch (error) {
                console.error('Error fetching history:', error);
                alert('Could not load transaction history.');
            }
        }

        function confirmLogout() {
            if (confirm('Are you sure you want to logout?')) {
                logout();
            }
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'student-login.html';
        }

        // UI Helper functions for cart sidebar
        function toggleCart() {
            document.getElementById('cartSidebar').classList.toggle('open');
            document.getElementById('cartOverlay').classList.toggle('show');
        }

        function closeCart() {
            document.getElementById('cartSidebar').classList.remove('open');
            document.getElementById('cartOverlay').classList.remove('show');
        }

    </script>
</body>
</html>