<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TuckshopKonnect</title>
    
    <!-- External CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Same styles as before */
    </style>
</head>

<body>
    <div class="sidebar">
        <!-- Sidebar content remains the same -->
    </div>

    <main class="main-content">
        <header class="header">
            <h2 id="pageTitle" class="page-title">Dashboard</h2>
            <div class="admin-profile">
                <div id="adminName" class="text-white fw-bold">Administrator</div>
                <div id="adminInitials" class="admin-initials">A</div>
            </div>
        </header>

        <!-- All sections with their content -->
        <!-- ... HTML structure from before ... -->

    </main>

    <!-- Item Modal -->
    <!-- ... Modal structure from before ... -->

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        let itemModal;
        let adminToken;

        document.addEventListener('DOMContentLoaded', function() {
            itemModal = new bootstrap.Modal(document.getElementById('itemModal'));
            adminToken = sessionStorage.getItem('adminToken');
            if (!adminToken) {
                window.location.href = 'index.html';
                return;
            }
            setupAdminUI(JSON.parse(sessionStorage.getItem('adminUser')));
            addEventListeners();
            showSection('dashboard');
        });

        function setupAdminUI(user) {
            document.getElementById('adminName').textContent = user.name || 'Administrator';
            document.getElementById('adminInitials').textContent = (user.name || 'A').charAt(0).toUpperCase();
        }

        function addEventListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionName = this.getAttribute('data-section');
                    showSection(sectionName);
                });
            });
            document.getElementById('itemSearch').addEventListener('input', () => fetchItems(1, document.getElementById('itemSearch').value));
        }

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionName).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.nav-link[data-section="${sectionName}"]`).classList.add('active');
            document.getElementById('pageTitle').textContent = document.querySelector(`.nav-link[data-section="${sectionName}"] span`).textContent;

            if (sectionName === 'dashboard') fetchDashboardData();
            if (sectionName === 'items') fetchItems();
            if (sectionName === 'transactions') fetchTransactions();
        }

        async function fetchDashboardData() {
            const headers = { 'Authorization': `Bearer ${adminToken}` };
            try {
                const [usersRes, itemsRes, transRes] = await Promise.all([
                    fetch('/api/users', { headers }),
                    fetch('/api/items', { headers }),
                    fetch('/api/transactions/all', { headers })
                ]);
                const users = await usersRes.json();
                const items = await itemsRes.json();
                const transactions = await transRes.json();

                document.getElementById('totalUsers').textContent = users.totalUsers || 'N/A';
                document.getElementById('totalItems').textContent = items.totalItems || 'N/A';
                document.getElementById('totalTransactions').textContent = transactions.count || 'N/A';

                const recentTransactions = transactions.transactions.slice(0, 5);
                const recentTransTable = document.getElementById('recentTransactionsTable');
                recentTransTable.innerHTML = recentTransactions.map(t => `
                    <tr>
                        <td>${t.user.name}</td>
                        <td>${t.type}</td>
                        <td>₦${t.amount.toLocaleString()}</td>
                        <td>${new Date(t.createdAt).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error("Error fetching dashboard data:", error);
            }
        }

        async function fetchItems(page = 1, search = '') {
            const response = await fetch(`/api/items?page=${page}&limit=10&search=${search}`, { headers: { 'Authorization': `Bearer ${adminToken}` } });
            const data = await response.json();
            const itemsTable = document.getElementById('itemsTable');
            itemsTable.innerHTML = data.items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>₦${item.price.toLocaleString()}</td>
                    <td>${item.stock}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick='openItemModal(${JSON.stringify(item)})'>Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem('${item._id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
            renderPagination('itemsPagination', data.totalPages, page, (p) => fetchItems(p, search));
        }

        async function saveItem() {
            const itemId = document.getElementById('itemId').value;
            const item = {
                name: document.getElementById('itemName').value,
                price: document.getElementById('itemPrice').value,
                description: document.getElementById('itemDescription').value,
                stock: document.getElementById('itemStock').value
            };
            const method = itemId ? 'PUT' : 'POST';
            const url = itemId ? `/api/items/${itemId}` : '/api/items';

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                body: JSON.stringify(item)
            });
            if (response.ok) {
                itemModal.hide();
                fetchItems();
            } else {
                alert('Failed to save item');
            }
        }

        async function deleteItem(itemId) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            const response = await fetch(`/api/items/${itemId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            if (response.ok) {
                fetchItems();
            } else {
                alert('Failed to delete item');
            }
        }

        async function fetchTransactions(page = 1) {
            const userId = document.getElementById('transactionUserFilter').value;
            const type = document.getElementById('transactionTypeFilter').value;
            let url = `/api/transactions/all?page=${page}&limit=10`;
            if (userId) url += `&userId=${userId}`;
            if (type) url += `&type=${type}`;

            const response = await fetch(url, { headers: { 'Authorization': `Bearer ${adminToken}` } });
            const data = await response.json();
            const transTable = document.getElementById('transactionsTable');
            transTable.innerHTML = data.transactions.map(t => `
                <tr>
                    <td>${t.user ? t.user.name : 'N/A'}</td>
                    <td>${t.type}</td>
                    <td>₦${t.amount.toLocaleString()}</td>
                    <td>${new Date(t.createdAt).toLocaleDateString()}</td>
                    <td>${t.status}</td>
                </tr>
            `).join('');
            renderPagination('transactionsPagination', data.totalPages, page, fetchTransactions);
        }

        function applyTransactionFilters() {
            fetchTransactions(1);
        }

        function renderPagination(elementId, totalPages, currentPage, fetchFn) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); ${fetchFn.name}(${i})">${i}</a>`;
                container.appendChild(li);
            }
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
